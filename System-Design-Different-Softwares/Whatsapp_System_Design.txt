ğŸ” PHASE-1: Requirement Clarification
ğŸ”„ Functional Requirements (Core)
Say this clearly:
    âœ”ï¸ 1-to-1 messaging
    âœ”ï¸ Group chats
    âœ”ï¸ Message delivery status (sent, delivered, read)
    âœ”ï¸ Online / last seen status
    âœ”ï¸ Media sharing (images, videos, docs)
    âœ”ï¸ Push notifications


ğŸ”„ Out of Scope (State explicitly)
â¤ Status (stories)
â¤ Payments
â¤ Voice / video calls
â¤ Ads
ğŸ‘‰ Interviewers like scope control.


ğŸ”„ Non-Functional Requirements (CRITICAL)
| Requirement  | Expectation         |
| ------------ | ------------------- |
| Latency      | Real-time (<100 ms) |
| Availability | Very high           |
| Consistency  | Strong per chat     |
| Scale        | 1B+ users           |
| Durability   | No message loss     |
| Ordering     | Guaranteed          |
ğŸ‘‰ â€œMessage ordering and durability are non-negotiable.â€


ğŸ” PHASE-2: High-Level Architecture
Mobile App
   â†“
WebSocket / TCP
   â†“
Load Balancer
   â†“
Chat Servers (Stateful)
   â†“
Message Queue (Kafka)
   â†“
Databases + Cache


ğŸ”„ Key Architectural Decisions
â¤ Persistent connection (WebSocket / TCP)
â¤ Stateful chat servers
â¤ Async delivery
â¤ Store-and-forward model
â€œUnlike Instagram, WhatsApp uses long-lived connections.â€


ğŸ” PHASE-3: Core Services
| Service              | Responsibility          |
| -------------------- | ----------------------- |
| Auth Service         | User identity           |
| Connection Service   | Maintain sockets        |
| Chat Service         | Send / receive messages |
| Message Store        | Durable storage         |
| Notification Service | Offline push            |
| Media Service        | Media upload/download   |


ğŸ” PHASE-4: Message Sending
ğŸ”¥ 1-to-1 Message Flow
Sender App
 â†’ WebSocket
 â†’ Chat Server
 â†’ Persist Message
 â†’ Deliver to Receiver
 â†’ ACKs

ğŸ”„ Step-by-Step
1ï¸âƒ£ Sender sends message via socket
2ï¸âƒ£ Chat server assigns message_id
3ï¸âƒ£ Message stored in DB
4ï¸âƒ£ If receiver online â†’ push instantly
5ï¸âƒ£ If offline â†’ queue message
5ï¸âƒ£ Delivery ACK updated
ğŸ‘‰ â€œMessage is persisted before delivery to avoid loss.â€

ğŸ”„ Message Schema
message_id (PK)
chat_id
sender_id
content
timestamp
status

ğŸ” PHASE-5: Message Ordering (INTERVIEW FAVORITE)
ğŸ”„ Problem
â¤ Distributed servers â†’ out-of-order messages

âœ”ï¸ Solution
â¤ Per-chat sequence number
â¤ Assigned by chat server

ğŸ‘‰ â€œOrdering is guaranteed per chat, not globally.â€

ğŸ” PHASE-6: Online / Offline Handling
ğŸ”„ Online Users
â¤ Socket connected
â¤ Stored in memory / Redis

ğŸ”„ Offline Users
â¤ Messages stored
â¤ Push notification sent

ğŸ‘‰ Tech:
â¤ Redis (presence)
â¤ FCM / APNs (push)


ğŸ” PHASE-7: Read Receipts (âœ”ï¸âœ”ï¸ TICK, DOUBLE TICK, BLUE TICK)
ğŸ”„ Status Flow
| Status    | Meaning          |
| --------- | ---------------- |
| Sent      | Server received  |
| Delivered | Receiver device  |
| Read      | User opened chat |

ğŸ”„ Storage
â¤ Status stored per message
â¤ Updated asynchronously


ğŸ” PHASE-8: Group Chats (HARD PART)
ğŸ”¥ Group Message Flow
Sender
 â†’ Chat Server
 â†’ Fan-out to group members

ğŸ”„ Group Challenges
â¤ Fan-out explosion
â¤ Partial delivery failures
â¤ Consistency

âœ”ï¸ Solutions
â¤ Server-side fan-out
â¤ Batched writes
â¤ Retry queues

ğŸ‘‰ â€œGroups trade latency for reliability.â€


ğŸ” PHASE-9: Media Sharing
ğŸ”„ Flow
Client
 â†’ Get pre-signed URL
 â†’ Upload to S3
 â†’ Send media reference
ğŸ‘‰ Media is not sent via chat servers.


ğŸ” PHASE-10: Database Design
ğŸ”„ Choice
| Data     | Tech      |
| -------- | --------- |
| Messages | Cassandra |
| Users    | SQL       |
| Presence | Redis     |
| Media    | S3        |

ğŸ‘‰ Why Cassandra?
â¤ High write throughput
â¤ Partitioned by chat_id


ğŸ” PHASE-11: Scaling Strategy
ğŸ”„ Chat Servers
â¤ Sharded by user_id
â¤ Sticky connections

ğŸ”„ DB Scaling
â¤ Partition by chat_id
â¤ Replication

ğŸ” PHASE-12: Reliability & Fault Tolerance
â¤ Message retries
â¤ Idempotent message_id
â¤ WAL logs
â¤ DLQ in Kafka


ğŸ” PHASE-13: Security 
â¤ End-to-end encryption
â¤ TLS
â¤ Key exchange (Signal protocol)
â¤ Message encrypted at client
ğŸ‘‰ â€œServers cannot read message content.â€


ğŸ¯ COMMON TRAPS
âŒ Ignoring message ordering
âŒ Using HTTP instead of sockets
âŒ Forgetting offline users
âŒ Not persisting before delivery
